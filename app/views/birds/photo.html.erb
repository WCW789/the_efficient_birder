<%= link_to "Manually Add Bird Entry", new_bird_path %>
<br><br>

<h1> Take Photo </h1>

<video id="video" autoplay height=100></video>
<br>
<canvas id="canvas" height=100 width=125></canvas>

<%= form_with model: @bird, url: "/birds/photo", method: :post, local: true do |form| %>

  <%= form.hidden_field :blob_field, :value => "no blob yet" %>
  <%= form.hidden_field :user_id %>
  <%= form.hidden_field :name %>
  <%= form.hidden_field :datetime %>
  <%= form.hidden_field :latitude, id: 'latitude' %>
  <%= form.hidden_field :longitude, id: 'longitude' %>
  <%= form.hidden_field :notes %>

  <div>
    <%= form.submit "Submit", id: "captureButton" %>
  </div>
<% end %>

<script>
const latitudeInput = document.getElementById('latitude')
const longitudeInput = document.getElementById('longitude')

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const captureButton = document.getElementById('captureButton');

navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
        video.srcObject = stream;
    })
    .catch(error => {
        console.error('Error accessing the camera:', error);
    });

captureButton.addEventListener('click', (event) => {
      event.preventDefault();

      canvas.width = 125
      canvas.height = 100
      const context = canvas.getContext('2d');
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      const imageUrl = canvas.toDataURL('image/jpeg');
      document.getElementById('blob_field').value = imageUrl;

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const latitude = position.coords.latitude;
          const longitude = position.coords.longitude;

          latitudeInput.value = latitude;
          longitudeInput.value = longitude;

          localStorage.setItem('latitude', latitudeInput.value);
          localStorage.setItem('longitude', longitudeInput.value);

          captureButton.form.submit();
        },
        (error) => {
          console.log('Error getting location:', error);
        },
        {
          enableHighAccuracy: true,
          maximumAge: 0, 
        }
      )
      
      canvas.toBlob(function (blob) {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/birds/photo', true);

        var csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        xhr.setRequestHeader('X-CSRF-Token', csrfToken);

        const formData = new FormData();
        formData.append('blobb', blob, 'snapshot.jpeg');

        xhr.onload = function() { 
          if (xhr.status === 200) {
            console.log('Image upload successful!', imageUrl);
    
            const response = xhr.responseText;
            console.log('Server response:', response);

          } else {
            console.error('Image upload failed. Status:', xhr.status);
          }
        }
        xhr.send(formData);
      }, 'image/jpeg');
    });

 </script>
 </body>
</html>
